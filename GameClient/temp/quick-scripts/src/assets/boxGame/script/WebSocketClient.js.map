{"version":3,"sources":["assets/boxGame/script/WebSocketClient.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { SocketState } from \"../../c2f-framework/net/ws/WebService\";\n\n\nexport class WebSocketClient {\n    protected socket: WebSocket;\n    protected state: SocketState;\n    protected url: string;\n\n    protected connectCb: Function;    //连接成功回调\n    protected messageCb: Function;    //收到消息回调\n    protected wsEventCb: Function;    //网络事件回调\n\n    protected reconnectTimes: number; //重连次数\n    protected reconnectTimer: NodeJS.Timeout; //重连timer    \n\n    private heartbeatTimer: NodeJS.Timeout\n\n    //重连最大次数\n    reconnetMax = 5;\n    //重连间隔\n    reconnetInterval = 6;\n\n    constructor() {\n        this.socket = null;\n        this.state = SocketState.Error;\n        this.url = null;\n\n        this.reconnectTimes = 0;\n        this.reconnectTimer = null;\n        this.connectCb = null;\n    }\n\n    /** 消息回调 */\n    public setMessageCb(cb: Function) {\n        this.messageCb = cb;\n    }\n\n    /** socket事件回调 */\n    public setWsEventCb(cb: Function) {\n        this.wsEventCb = cb;\n    }\n\n    /** socket连接成功 */\n    private onOpen(event: any) {\n        cc.log(\" WebSocketClient  Send Text WS was opened.\");\n        this.reconnectTimes = 0;\n        this.stateChanged(SocketState.Connected);\n        this.startHeartbeat()\n    }\n\n    private startHeartbeat() {\n        this.clearHeartbeatTimer()\n        this.heartbeatTimer = setInterval(() => {\n            let data = \"\".concat(JSON.stringify({\n                arguments: [],\n                target: \"Heartbeat\",\n                type: 1\n            })).concat(String.fromCharCode(30))\n            this.tcpSend(data);\n        }, this.reconnetInterval * 1000);\n    }\n\n\n    /** 发送消息: 子类具体实现 */\n    public tcpSend(data: string) {\n        if (this.state === SocketState.Connected) {\n            console.log(' WebSocketClient tcpSend :', data);\n            let dataTemp = data.concat(String.fromCharCode(30))\n            this.socket.send(dataTemp)\n        }\n\n    }\n\n    /** 收到消息：子类具体实现 */\n    protected onMessage(event: any) {\n        console.log(' WebSocketClient Received from server:', event.data);\n        let e = event.data.replace(String.fromCharCode(30), \"\")\n        let data = JSON.parse(e);\n        if (1 === data.type) {\n            switch (data.target) {\n                case \"PushMessage\":\n                    console.log(\"收到服务器内容：\" + JSON.stringify(data.arguments[0]));\n                    break\n            }\n        }\n\n    }\n\n    /** 网络错误 */\n    private onError(event) {\n        cc.log(\"WebSocketClient fired an error\");\n        let target = event.currentTarget || event.target;\n        if (this.socket && this.socket.readyState != WebSocket.CLOSED && this.url && target && target.url == this.url) {\n            this.stateChanged(SocketState.Error);\n        }\n    }\n\n    /** 网络断开 */\n    private onClosed(event) {\n        cc.log(\"WebSocketClient instance closed.\");\n        let target = event.currentTarget || event.target;\n        if (this.url && target && target.url == this.url) {\n            if (target) {\n                cc.log(\"WebSocketClient instance closed:\" + target.readyState);\n            }\n            this.stateChanged(SocketState.ConnectTimeOut);\n            // this.reconnect(this.url);\n        }\n    }\n    /** 连接socket */\n    public tcpConnet(url: string, callback: Function) {\n        this.url = url;\n        if (this.socket) {\n            this.socket.close();\n            this.socket.onopen = null;\n            this.socket.onmessage = null;\n            this.socket.onerror = null;\n            this.socket.onclose = null;\n            this.socket = null;\n        }\n        this.connectCb = callback;\n\n        cc.log(\"websocket connect\", url);\n        this.socket = new WebSocket(url);\n        // this.socket.binaryType = \"arraybuffer\";\n        this.socket.onopen = this.onOpen.bind(this);\n        this.socket.onmessage = this.onMessage.bind(this);\n        this.socket.onerror = this.onError.bind(this);\n        this.socket.onclose = this.onClosed.bind(this);\n    }\n    /** 重新连接 */\n    private reconnect(url: string) {\n        if (!this.url) {\n            return;\n        }\n        //最大重连次数5次\n        if (this.reconnectTimes > this.reconnetMax) {\n            this.stateChanged(SocketState.Error);\n            return;\n        }\n        this.reconnectTimer = setTimeout(() => {\n            this.reconnectTimer = null;\n            if (this.url) {\n                this.reconnectTimes++;\n                this.tcpConnet(url, () => {\n                    if (this.socket.readyState == WebSocket.OPEN && this.url) {\n                        this.wsEventCb && this.wsEventCb(SocketState.ReconnectSuc);\n                    }\n                });\n            }\n        }, this.reconnetInterval * 1000);\n    }\n\n    public stateChanged(state: SocketState) {\n        this.state = state;\n        if (state === SocketState.Connecting) {\n\n        } else {\n            let reason = \"\";\n            switch (state) {\n                case SocketState.ConnectTimeOut:\n                    reason = \"ConnectTimeOut\";\n                    break;\n                case SocketState.Connected:\n                    reason = \"Connected\";\n                    break;\n                case SocketState.Error:\n                    reason = \"SocketError\";\n                    break;\n                default:\n                    break;\n            }\n\n            this.wsEventCb && this.wsEventCb(state);\n            if (this.connectCb) {\n                this.connectCb(reason);\n                this.connectCb = null;\n            }\n        }\n    }\n\n    public purge() {\n        this.clearReconnectTimer();\n        if (this.socket) {\n            this.socket.close();\n            this.socket = null;\n            this.url = null;\n            this.reconnectTimes = 0;\n        }\n        this.clearHeartbeatTimer();\n    }\n\n    public clearReconnectTimer() {\n        if (this.reconnectTimer) {\n            clearTimeout(this.reconnectTimer);\n            this.reconnectTimes = null;\n        }\n    }\n\n    /** 清除心跳timer */\n    private clearHeartbeatTimer() {\n        if (this.heartbeatTimer) {\n            clearInterval(this.heartbeatTimer);\n            this.heartbeatTimer = null;\n        }\n    }\n\n\n\n}\n\n"]}